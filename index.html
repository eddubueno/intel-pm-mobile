<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Intel PM — Operações</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#06090d;           /* fundo */
    --panel:#0b1220;        /* cartões */
    --ink:#e8f2ff;          /* texto principal */
    --muted:#89a2b8;        /* texto secundário */
    --line:rgba(255,255,255,.08);
    --accent:#00e0c6;       /* ciano */
    --accent2:#77a8ff;      /* azul */
    --ok:#46ff93; 
    --danger:#ff5b6b;
    --warn:#ffd166;
    --glass:linear-gradient(180deg,rgba(19,32,54,.75),rgba(13,20,32,.85));
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 78% -10%,#0f1b2c 0%,#08111b 55%,#06090d 100%);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  a{color:var(--accent);text-decoration:none}
  /* HEADER */
  header{position:sticky;top:0;z-index:50;border-bottom:1px solid var(--line);background:linear-gradient(0deg,rgba(8,16,26,.6),rgba(8,16,26,.95));backdrop-filter:saturate(1.3) blur(10px)}
  .bar{display:flex;align-items:center;gap:12px;padding:12px 14px}
  .brand{font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);}
  .status{font-size:.78rem;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted)}
  .grow{flex:1}
  .btn{appearance:none;border:1px solid var(--line);background:var(--panel);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.primary{border-color:transparent;background:linear-gradient(180deg, rgba(0,224,198,.22), rgba(0,224,198,.06));}
  .btn.ghost{background:transparent}
  .btn.warn{border-color:rgba(255,91,107,.2);background:linear-gradient(180deg,rgba(255,91,107,.14),rgba(255,91,107,.04))}
  .btn:active{transform:scale(.98)}
  /* LAYOUT */
  main{padding:18px;display:grid;gap:18px;grid-template-columns:340px 1fr}
  @media (max-width:980px){ main{grid-template-columns:1fr} }
  .card{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--glass)}
  .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .card .title{font-weight:800;letter-spacing:.02em}
  .card .body{padding:14px}
  .hint{color:var(--muted);font-size:.88rem}
  /* QUICK / ATALHOS */
  .quick{display:grid;gap:10px}
  .qbtn{display:flex;align-items:center;gap:.6rem;justify-content:center;border:1px dashed rgba(0,224,198,.25);background:rgba(0,224,198,.06);padding:12px;border-radius:12px;font-weight:700}
  .qbtn:hover{border-style:solid}
  /* FORM */
  form{display:grid;gap:12px}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:740px){ .cols-2,.cols-3{grid-template-columns:1fr} }
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:.86rem;color:var(--muted)}
  .field input, .field select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--ink);font-size:1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row .btn{flex:1}
  .pill{border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:var(--muted);font-size:.75rem}
  .list{display:grid;gap:10px}
  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
  .muted{color:var(--muted)}
  /* BADGES */
  .b-ok{color:var(--ok)} .b-warn{color:var(--warn)} .b-danger{color:var(--danger)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="bar">
      <div class="brand">INTEL • PM</div>
      <div class="status" id="status">pronto</div>
      <div class="grow"></div>
      <button class="btn ghost" id="btnFS">Tela Cheia</button>
    </div>
  </header>

  <main>
    <!-- LADO ESQUERDO: ATALHOS -->
    <section class="card">
      <div class="head">
        <div class="title">Atalhos de Inteligência</div>
        <span class="pill">acesso rápido</span>
      </div>
      <div class="body">
        <div class="quick">
          <button class="qbtn" data-open="https://portalbnmp.cnj.jus.br/#/captcha/%2Fpesquisa-peca">BNMP — Mandados</button>
          <button class="qbtn" data-open="https://extrajudicial.tjsp.jus.br/validade-selo">Validade de Selo — TJSP</button>
          <button class="qbtn" data-open="https://esaj.tjsp.jus.br/cpopg/open.do">Consulta Processo — TJSP</button>
        </div>
        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">
        <div class="title" style="font-size:.95rem;margin-bottom:8px">Buscas com filtro (Google)</div>
        <div class="grid cols-2">
          <button class="btn" id="gBNMP">Buscar em BNMP</button>
          <button class="btn" id="gTJSP">Buscar em TJSP</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="gComb">Busca combinada</button>
        </div>
        <div class="hint" style="margin-top:8px">As buscas usam <b>site:</b> (CNJ / BNMP / ESAJ) e abrem em nova aba.</div>
      </div>
    </section>

    <!-- LADO DIREITO: FORM + LISTA -->
    <section class="card">
      <div class="head">
        <div class="title">Registrar abordado</div>
        <span class="pill">dados locais</span>
      </div>
      <div class="body">
        <!-- FORM com layout intuitivo -->
        <form id="formAbordado" autocomplete="off">
          <!-- Linha 1: RG + Nome (obrigatórios) -->
          <div class="grid cols-2">
            <div class="field">
              <label for="rg">RG (apenas 8 dígitos) <span class="b-warn">*</span></label>
              <input id="rg" name="rg" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="________" required>
            </div>
            <div class="field">
              <label for="nome">Nome completo <span class="b-warn">*</span></label>
              <input id="nome" name="nome" placeholder="Ex.: João da Silva" required>
            </div>
          </div>

          <!-- Linha 2: flags obrigatórias -->
          <div class="grid cols-3">
            <div class="field">
              <label>Criminal? <span class="b-warn">*</span></label>
              <div class="row">
                <label><input type="radio" name="criminal" value="sim" required> Sim</label>
                <label><input type="radio" name="criminal" value="nao" required> Não</label>
              </div>
            </div>
            <div class="field">
              <label>Passagem criminal?</label>
              <div class="row">
                <button class="btn" type="button" id="passSim">Sim</button>
                <button class="btn" type="button" id="passNao">Não</button>
                <input type="hidden" id="passagem" value="nao">
              </div>
            </div>
            <div class="field">
              <label for="matricula">Matrícula (opcional)</label>
              <input id="matricula" placeholder="12345">
            </div>
          </div>

          <!-- Linha 3: parentais e nascimento -->
          <div class="grid cols-3">
            <div class="field">
              <label for="nasc">Nascimento (opcional)</label>
              <input id="nasc" type="date">
            </div>
            <div class="field">
              <label for="pai">Nome do pai (opcional)</label>
              <input id="pai">
            </div>
            <div class="field">
              <label for="mae">Nome da mãe (opcional)</label>
              <input id="mae">
            </div>
          </div>

          <!-- Linha 4: endereço + timestamp (automáticos) -->
          <div class="grid cols-2">
            <div class="field">
              <label for="endereco">Endereço (auto)</label>
              <input id="endereco" placeholder="Obtendo localização..." />
            </div>
            <div class="field">
              <label for="hora">Data/Hora</label>
              <input id="hora" readonly />
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <button class="btn primary" id="btnAdd" type="submit">Adicionar</button>
            <button class="btn" type="button" id="btnLimparForm">Limpar</button>
            <button class="btn" type="button" id="btnExport">Exportar CSV</button>
          </div>
          <div class="hint" style="margin-top:8px">Tudo fica salvo <b>neste aparelho</b> (localStorage). Endereço usa geolocalização + reverse (OpenStreetMap).</div>
        </form>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

        <!-- LISTA DO DIA -->
        <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:6px">
          <div class="title" style="font-size:1rem">Abordados do dia</div>
          <span class="pill" id="countHint">0</span>
        </div>
        <div id="lista" class="list">
          <div class="hint muted">Nenhum registro hoje.</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="hint" style="text-align:center;padding:14px">© Operações — uso interno. Ajuste conforme normas.</footer>
</div>

<script>
/* ======== UTIL ======== */
const $ = sel => document.querySelector(sel);
const ls = (k,v)=> v===undefined ? JSON.parse(localStorage.getItem(k)||'null') : localStorage.setItem(k, JSON.stringify(v));
const todayKey = ()=> new Date().toISOString().slice(0,10);
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='18px'; t.style.transform='translateX(-50%)';
  t.style.background='rgba(9,16,24,.95)'; t.style.border='1px solid rgba(255,255,255,.08)'; t.style.padding='8px 12px'; t.style.borderRadius='10px'; t.style.zIndex=9999;
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600);
}
function nowStr(){ return new Date().toLocaleString(); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* ======== ATALHOS ======== */
for (const el of document.querySelectorAll('[data-open]')) {
  el.addEventListener('click', e => window.open(e.currentTarget.getAttribute('data-open'), '_blank', 'noopener'));
}
function q(v){return encodeURIComponent(v)}
function getTerms(){
  return {
    nome: $('#nome').value.trim(),
    rg: $('#rg').value.trim()
  };
}
$('#gBNMP').addEventListener('click', ()=>{
  const {nome,rg} = getTerms(); const terms=[nome,rg].filter(Boolean).join(' ');
  window.open(`https://www.google.com/search?q=${q(terms)}+site%3Acnj.jus.br+OR+site%3Aportalbnmp.cnj.jus.br`,'_blank');
});
$('#gTJSP').addEventListener('click', ()=>{
  const {nome,rg} = getTerms(); const terms=[nome,rg].filter(Boolean).join(' ');
  window.open(`https://www.google.com/search?q=${q(terms)}+site%3Aesaj.tjsp.jus.br`,'_blank');
});
$('#gComb').addEventListener('click', ()=>{
  const {nome,rg} = getTerms(); const terms=[nome,rg].filter(Boolean).join(' ');
  window.open(`https://www.google.com/search?q=${q(terms)}+site%3Acnj.jus.br+OR+site%3Aportalbnmp.cnj.jus.br+OR+site%3Aesaj.tjsp.jus.br`,'_blank');
});

/* ======== FORM ======== */
const form = $('#formAbordado');
const rg = $('#rg'); const nome = $('#nome'); const hora = $('#hora'); const endereco = $('#endereco');
const nasc=$('#nasc'), pai=$('#pai'), mae=$('#mae'), matricula=$('#matricula');
const passSim=$('#passSim'), passNao=$('#passNao'), passagemHidden=$('#passagem');
const listaEl = $('#lista'), countHint = $('#countHint');

let coords=null;

/* RG: só números e no máximo 8 */
rg.addEventListener('input', e=>{
  const clean = e.target.value.replace(/\D/g,'').slice(0,8);
  e.target.value = clean;
});

/* Passagem toggle */
passSim.addEventListener('click', ()=>{ passagemHidden.value='sim'; toast('Passagem: Sim'); });
passNao.addEventListener('click', ()=>{ passagemHidden.value='nao'; toast('Passagem: Não'); });

/* Timestamp inicial */
function setNow(){ hora.value = nowStr(); }
setNow();

/* Geo + reverse (Nominatim) */
async function updateGeo(){
  if(!('geolocation' in navigator)) return;
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:10000,maximumAge:60000}));
    coords=[pos.coords.latitude,pos.coords.longitude];
    try{
      const u = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${coords[0]}&lon=${coords[1]}`;
      const r = await fetch(u); const j = await r.json();
      endereco.value = j?.display_name || `coords: ${coords[0].toFixed(5)}, ${coords[1].toFixed(5)}`;
    }catch{
      endereco.value = `coords: ${coords[0].toFixed(5)}, ${coords[1].toFixed(5)}`;
    }
  }catch{
    // silencioso
  }
}
updateGeo();

/* Salvar registro */
function saveRegistro(reg){
  const all = ls('intelpm.registros') || {};
  const key = reg.data.slice(0,10);
  if(!all[key]) all[key]=[];
  all[key].unshift(reg);
  ls('intelpm.registros', all);
}

/* Render lista de hoje */
function renderLista(){
  const all = ls('intelpm.registros') || {};
  const arr = all[todayKey()] || [];
  countHint.textContent = `${arr.length}`;
  if(!arr.length){ listaEl.innerHTML = `<div class="hint muted">Nenhum registro hoje.</div>`; return; }
  listaEl.innerHTML='';
  for(const r of arr){
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div>
          <strong>${esc(r.nome)}</strong> <span class="pill">${esc(r.rg)}</span><br>
          <span class="muted">${esc(r.hora)} — ${esc(r.endereco)}</span>
        </div>
        <div style="text-align:right">
          <span class="pill">${r.criminal?'Criminal':'Não criminal'}</span><br>
          <span class="muted">${r.passagem?'Passagem: Sim':'Passagem: Não'}</span>
        </div>
      </div>
    `;
    listaEl.appendChild(el);
  }
}
renderLista();

/* Limpar form */
$('#btnLimparForm').addEventListener('click', ()=>{
  form.reset(); passagemHidden.value='nao'; setNow(); toast('Limpo');
});

/* Export CSV (dia) */
$('#btnExport').addEventListener('click', ()=>{
  const all = ls('intelpm.registros') || {};
  const arr = all[todayKey()] || [];
  if(!arr.length){ toast('Nada para exportar'); return; }
  const cols=['data','hora','rg','nome','criminal','passagem','matricula','nasc','pai','mae','endereco','coords'];
  const rows=[cols.join(',')];
  for(const r of arr){ rows.push(cols.map(c=>`"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(',')); }
  const csv = rows.join('\n'); const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`abordados-${todayKey()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* Add registro */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const rgv = rg.value.trim();
  const nomev = nome.value.trim();
  const criminal = form.querySelector('input[name="criminal"]:checked');
  if(!rgv || rgv.length!==8 || !nomev || !criminal){ toast('Preencha: RG (8 dígitos), Nome e Criminal?'); return; }

  if(!coords) { try{ await updateGeo(); }catch{} }
  const reg = {
    id: uid(),
    data: new Date().toISOString(),
    hora: nowStr(),
    rg: rgv,
    nome: nomev,
    criminal: (criminal.value==='sim'),
    passagem: (passagemHidden.value==='sim'),
    matricula: matricula.value.trim(),
    nasc: nasc.value,
    pai: pai.value.trim(),
    mae: mae.value.trim(),
    endereco: endereco.value.trim(),
    coords: coords ? `${coords[0].toFixed(6)},${coords[1].toFixed(6)}` : ''
  };
  saveRegistro(reg);
  renderLista();
  form.reset(); passagemHidden.value='nao'; setNow();
  toast('Abordado adicionado');
});

/* Tela cheia */
$('#btnFS').addEventListener('click', ()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
});
</script>
</body>
</html>
