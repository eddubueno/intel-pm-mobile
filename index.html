<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Inteligência Móvel — PM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Source+Code+Pro:wght@500&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0A0F14; --panel:#0D141B; --ink:#E8F0F5; --muted:#9FB2BF;
    --accent:#00E0C6; --accent-2:#8AE5FF; --danger:#ff5252; --ok:#37ff7f;
    --line:rgba(255,255,255,.08); --glass:rgba(10,16,22,.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--ink);margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(0deg, rgba(10,16,22,.2), rgba(10,16,22,.8));backdrop-filter:saturate(1.4) blur(8px);border-bottom:1px solid var(--line)}
  .bar{display:flex;align-items:center;gap:.6rem;padding:12px 14px}
  .badge{font-weight:800;letter-spacing:.06em;text-transform:uppercase;font-size:.82rem;color:var(--accent)}
  .grow{flex:1}
  .btn{appearance:none;border:1px solid var(--line);background:var(--glass);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.icon{display:inline-flex;align-items:center;gap:.5rem}
  .btn.primary{border-color:transparent;background:linear-gradient(180deg, rgba(0,224,198,.25), rgba(0,224,198,.08));}
  .btn.warn{border-color:#ff6767;background:linear-gradient(180deg, rgba(255,103,103,.2), rgba(255,103,103,.06));}
  main{padding:16px;display:grid;gap:16px}
  .card{background:var(--glass);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .card .title{font-weight:800;letter-spacing:.02em}
  .card .body{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .input{display:flex;flex-direction:column;gap:6px}
  .input label{font-size:.82rem;color:var(--muted)}
  .input input, .input select, .input textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02);color:var(--ink);font-size:1rem}
  .hint{font-size:.86rem;color:var(--muted)}
  .quick{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .quick .qbtn{display:flex;align-items:center;gap:.6rem;border:1px solid var(--line);background:rgba(255,255,255,.03);padding:14px;border-radius:14px;font-weight:700;justify-content:center;text-align:center}
  .qbtn svg{width:22px;height:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row .btn{flex:1}
  .kbd{font-family:"Source Code Pro",ui-monospace,monospace;font-weight:600;border:1px solid var(--line);padding:2px 6px;border-radius:8px;background:rgba(255,255,255,.04)}
  footer{padding:14px;color:var(--muted);text-align:center}
  .small{font-size:.9rem}
  .ok{color:var(--ok)}
  .list{display:grid;gap:8px}
  .list a{display:flex;align-items:center;gap:.6rem;padding:12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);color:var(--ink);text-decoration:none}
  .list a:active{transform:scale(.98)}
  .pill{font-size:.72rem;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:var(--muted)}
  .caps{letter-spacing:.06em;text-transform:uppercase}
  .sr{position:absolute;left:-9999px}
  .toggle{display:inline-flex;gap:8px;align-items:center}
  .btn-yes{background:linear-gradient(180deg, rgba(55,255,127,.12), rgba(55,255,127,.04));border:1px solid rgba(55,255,127,.15)}
  .btn-no{background:linear-gradient(180deg, rgba(255,82,82,.06), rgba(255,82,82,.02));border:1px solid rgba(255,82,82,.08)}
  /* Large touch targets on phones */
  @media (max-width:740px){
    .grid.cols-2{grid-template-columns:1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr}
    .quick{grid-template-columns:1fr 1fr}
  }
  .empty{opacity:.6}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="bar">
      <div class="badge">INTEL PM • MÓVEL</div>
      <div class="pill caps" id="status">offline-ready</div>
      <div class="grow"></div>
      <button class="btn icon" id="btnTheme" title="Tema claro/escuro">
        Tema
      </button>
      <button class="btn icon" id="btnFS" title="Tela cheia">Tela</button>
    </div>
  </header>

  <main>
    <!-- FORMULÁRIO DE ABORDADO -->
    <section class="card" aria-labelledby="t-abordado">
      <div class="head"><div class="title" id="t-abordado">Registrar abordado</div><span class="hint">Os campos obrigatórios são marcados</span></div>
      <div class="body">
        <form id="formAbordado" autocomplete="off">
          <div class="grid cols-2">
            <div class="input">
              <label for="rg">RG <span style="color:#ffb86b">*</span></label>
              <input id="rg" name="rg" inputmode="numeric" pattern="[0-9]*" placeholder="Somente números" required />
              <div class="hint">Ao digitar RG o teclado numérico aparece (iOS/Android).</div>
            </div>
            <div class="input">
              <label for="nome">Nome completo <span style="color:#ffb86b">*</span></label>
              <input id="nome" name="nome" placeholder="Nome completo" required />
            </div>

            <div class="input">
              <label for="matricula">Matrícula (opcional)</label>
              <input id="matricula" name="matricula" placeholder="Ex.: 12345" />
            </div>
            <div class="input">
              <label for="nasc">Data de nascimento (opcional)</label>
              <input id="nasc" name="nasc" type="date" />
            </div>

            <div class="input">
              <label for="pai">Nome do pai (opcional)</label>
              <input id="pai" name="pai" />
            </div>
            <div class="input">
              <label for="mae">Nome da mãe (opcional)</label>
              <input id="mae" name="mae" />
            </div>
          </div>

          <div style="margin-top:8px" class="grid cols-2">
            <div class="input">
              <label>Criminal?</label>
              <div>
                <label style="margin-right:8px"><input type="radio" name="criminal" value="sim" required> Sim</label>
                <label><input type="radio" name="criminal" value="nao" required> Não</label>
              </div>
            </div>
            <div class="input">
              <label>Passagem criminal?</label>
              <div class="toggle">
                <button type="button" id="btnPassagemSim" class="btn btn-yes">Sim</button>
                <button type="button" id="btnPassagemNao" class="btn btn-no">Não</button>
                <input type="hidden" id="passagem" value="nao" />
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="grid cols-2">
            <div class="input">
              <label for="endereco">Endereço (preenchido automaticamente)</label>
              <input id="endereco" name="endereco" placeholder="Endereço / coordenadas" />
            </div>
            <div class="input">
              <label for="hora">Data / Hora da abordagem</label>
              <input id="hora" name="hora" readonly />
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <button class="btn primary" id="btnAdd" type="submit">Adicionar abordado</button>
            <button class="btn" type="button" id="btnLimparForm">Limpar</button>
            <button class="btn" type="button" id="btnExport">Exportar CSV</button>
          </div>

          <div style="margin-top:8px" class="hint">Se quiser preenchimento automático do nome pelo RG, configure uma API no código (RG_LOOKUP_URL).</div>
        </form>
      </div>
    </section>

    <!-- LISTA DO DIA -->
    <section class="card" aria-labelledby="t-lista">
      <div class="head"><div class="title" id="t-lista">Abordados do dia</div><span class="hint" id="countHint">0 registros hoje</span></div>
      <div class="body" id="listaContainer">
        <div id="lista" class="list empty">Nenhum registro hoje.</div>
      </div>
    </section>

    <!-- OUTROS CONTROLES RÁPIDOS -->
    <section class="card" aria-labelledby="t-config">
      <div class="head"><div class="title" id="t-config">Configurações rápidas</div></div>
      <div class="body">
        <div class="row">
          <button class="btn" id="btnClearAll">Apagar TODOS os registros (local)</button>
          <button class="btn" id="btnForceGeo">Atualizar minha localização agora</button>
        </div>
        <div style="margin-top:8px" class="hint">Os registros ficam neste aparelho. Para mais segurança, exporte e salve em servidor/pendrive corporativo.</div>
      </div>
    </section>
  </main>

  <footer>
    <div class="small">© Operacional — uso interno. Ajuste conforme normas.</div>
  </footer>
</div>

<script>
/*
  Implementação:
  - Salva entradas em localStorage por data (chave 'intelpm.registros')
  - Auto-preenche hora e busca geolocalização para endereço (Nominatim reverse)
  - Tentativa opcional de lookup por RG (configurar RG_LOOKUP_URL)
  - Exporta CSV e lista por dia
*/

// === CONFIGURAÇÕES ===
// Se tiver uma API que retorne { nome: "Fulano" } ao receber ?rg=... coloque a URL aqui.
// Ex: const RG_LOOKUP_URL = "https://meuservico.local/lookupRg";
const RG_LOOKUP_URL = null; // <-- deixe null se não tiver

// Nominatim (OpenStreetMap) é usado para reverse geocode; pode haver rate limit.
const NOMINATIM_BASE = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2';

const ls = (k,v) => v===undefined ? JSON.parse(localStorage.getItem(k) || 'null') : localStorage.setItem(k, JSON.stringify(v));
const todayKey = () => {
  const d = new Date(); return d.toISOString().slice(0,10); // YYYY-MM-DD
};

// elementos
const $ = sel => document.querySelector(sel);
const form = $('#formAbordado');
const rgInput = $('#rg');
const nomeInput = $('#nome');
const horaInput = $('#hora');
const enderecoInput = $('#endereco');
const listaEl = $('#lista');
const countHint = $('#countHint');
const btnPassSim = $('#btnPassagemSim');
const btnPassNao = $('#btnPassagemNao');
const passagemHidden = $('#passagem');

// estado
let currentCoords = null;

// helpers
function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='20px'; t.style.transform='translateX(-50%)';
  t.style.background='rgba(10,16,22,.95)'; t.style.border='1px solid rgba(255,255,255,.08)'; t.style.padding='8px 12px'; t.style.borderRadius='10px'; t.style.zIndex=9999;
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1600);
}
function nowFormatted(){
  return new Date().toLocaleString();
}

// valida RG (só números)
rgInput.addEventListener('input', e => {
  const v = e.target.value.replace(/\D/g,'');
  e.target.value = v;
  // se configurado RG_LOOKUP_URL, tente buscar nome automaticamente (após 6+ dígitos)
  if(RG_LOOKUP_URL && v.length >= 6){
    lookupRg(v);
  }
});

// lookup de RG (opcional)
async function lookupRg(rg){
  try{
    const url = RG_LOOKUP_URL + (RG_LOOKUP_URL.includes('?') ? '&' : '?') + 'rg=' + encodeURIComponent(rg);
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) return;
    const j = await res.json();
    if(j && j.nome){
      nomeInput.value = j.nome;
      toast('Nome preenchido pelo lookup');
    }
  }catch(e){
    // falha é tolerável
    //console.log('lookup failed', e);
  }
}

// geolocalização + reverse geocode
async function updateLocationAndAddress(){
  if(!('geolocation' in navigator)) return;
  const p = new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(pos => resolve(pos), err => reject(err), {timeout:10000, maximumAge:60000});
  });
  try{
    const pos = await p;
    currentCoords = [pos.coords.latitude, pos.coords.longitude];
    // tente reverse geocode
    try{
      const res = await fetch(`${NOMINATIM_BASE}&lat=${currentCoords[0]}&lon=${currentCoords[1]}`);
      if(res.ok){
        const j = await res.json();
        if(j && j.display_name){
          enderecoInput.value = j.display_name;
        } else {
          enderecoInput.value = `coords: ${currentCoords[0].toFixed(5)}, ${currentCoords[1].toFixed(5)}`;
        }
      } else {
        enderecoInput.value = `coords: ${currentCoords[0].toFixed(5)}, ${currentCoords[1].toFixed(5)}`;
      }
    }catch(e){
      enderecoInput.value = `coords: ${currentCoords[0].toFixed(5)}, ${currentCoords[1].toFixed(5)}`;
    }
    toast('Localização atualizada');
  }catch(err){
    // user denied or timed out
    //console.log('geo error', err);
    toast('Não foi possível obter localização (verifique permissões)');
  }
}

// montar e salvar registro
function saveRegistro(reg){
  const all = ls('intelpm.registros') || {};
  const key = reg.data.slice(0,10);
  if(!all[key]) all[key] = [];
  all[key].unshift(reg);
  ls('intelpm.registros', all);
}

// render lista do dia
function renderLista(){
  const key = todayKey();
  const all = ls('intelpm.registros') || {};
  const hoje = all[key] || [];
  countHint.textContent = `${hoje.length} registro(s) hoje`;
  if(hoje.length === 0){
    listaEl.innerHTML = '<div class="empty">Nenhum registro hoje.</div>';
    return;
  }
  listaEl.innerHTML = '';
  for(const r of hoje){
    const node = document.createElement('div');
    node.className = 'list-item';
    node.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div>
          <strong>${escapeHtml(r.nome || '—')}</strong> <span class="pill">${r.rg || ''}</span><br/>
          <small class="small">${escapeHtml(r.hora)} — ${escapeHtml(r.endereco || '')}</small>
        </div>
        <div style="text-align:right">
          <div class="pill">${r.criminal? 'Criminal' : 'Não criminal'}</div>
          <div style="margin-top:6px"><button class="btn" data-id="${r.id}" data-date="${r.data}">Detalhes</button></div>
        </div>
      </div>
      <div style="margin-top:8px;color:var(--muted)">${r.matricula? 'Matrícula: '+escapeHtml(r.matricula)+' • ' : ''}${r.nasc? 'Nasc: '+escapeHtml(r.nasc) : ''}</div>
    `;
    listaEl.appendChild(node);
  }
  // bind detalhes (alert)
  for(const b of listaEl.querySelectorAll('button[data-id]')){
    b.addEventListener('click', (e)=>{
      const id = e.currentTarget.getAttribute('data-id');
      const date = e.currentTarget.getAttribute('data-date');
      const all = ls('intelpm.registros') || {};
      const r = (all[date] || []).find(x => x.id === id);
      if(r){
        alert(
`Detalhes:
Nome: ${r.nome}
RG: ${r.rg}
Hora: ${r.hora}
Endereço: ${r.endereco}
Criminal: ${r.criminal ? 'Sim':'Não'}
Passagem criminal: ${r.passagem ? 'Sim':'Não'}
Matrícula: ${r.matricula || '-'}
Nascimento: ${r.nasc || '-'}
Pai/Mãe: ${r.pai || '-'} / ${r.mae || '-'}
Obs: ${r.obs || '-'}`
        );
      }
    });
  }
}

// CSV export do dia
function exportCSV(){
  const key = todayKey();
  const all = ls('intelpm.registros') || {};
  const hoje = all[key] || [];
  if(hoje.length === 0){ toast('Nada para exportar'); return; }
  const cols = ['data','hora','rg','nome','matricula','nasc','pai','mae','criminal','passagem','endereco','coords'];
  const rows = [cols.join(',')];
  for(const r of hoje){
    const row = cols.map(c => `"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(',');
    rows.push(row);
  }
  const csv = rows.join('\n');
  // cria link de download
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `abordados-${key}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast('CSV gerado');
}

// escape
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// cria id simples
function uid(){ return Math.random().toString(36).slice(2,9); }

// inicializa hora do formulário
function setHoraNow(){
  horaInput.value = new Date().toLocaleString();
}

// manipulação botões passagem criminal
btnPassSim.addEventListener('click', ()=>{ passagemHidden.value='sim'; btnPassSim.classList.add('active'); toast('Passagem: Sim'); });
btnPassNao.addEventListener('click', ()=>{ passagemHidden.value='nao'; btnPassNao.classList.add('active'); toast('Passagem: Não'); });

// limpar form
$('#btnLimparForm').addEventListener('click', (e)=>{
  form.reset();
  setHoraNow();
  enderecoInput.value = '';
  toast('Formulário limpo');
});

// força obter localização
$('#btnForceGeo').addEventListener('click', ()=> updateLocationAndAddress());

// export CSV
$('#btnExport').addEventListener('click', exportCSV);

// apagar todos (local)
$('#btnClearAll').addEventListener('click', ()=>{
  if(confirm('Apagar TODOS os registros salvos neste aparelho?')){ localStorage.removeItem('intelpm.registros'); renderLista(); toast('Registros apagados'); }
});

// submissão do formulário (adicionar abordado)
form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  // valida básicos
  const rg = rgInput.value.trim();
  const nome = nomeInput.value.trim();
  const criminal = form.querySelector('input[name="criminal"]:checked');
  if(!rg || !nome || !criminal){
    toast('Preencha RG, Nome e marque "Criminal?"');
    return;
  }
  // pega campos opcionais
  const matricula = $('#matricula').value.trim();
  const nasc = $('#nasc').value;
  const pai = $('#pai').value.trim();
  const mae = $('#mae').value.trim();
  const passagem = passagemHidden.value === 'sim';
  // hora atual (garante timestamp)
  const dataHora = new Date();
  // se não temos coords atuais, tenta pegar (não bloqueia UI totalmente)
  if(!currentCoords && 'geolocation' in navigator){
    try{
      await updateLocationAndAddress();
    }catch(e){}
  }
  const coords = currentCoords ? `${currentCoords[0].toFixed(6)},${currentCoords[1].toFixed(6)}` : '';
  const endereco = enderecoInput.value.trim() || coords;

  const reg = {
    id: uid(),
    data: dataHora.toISOString(),
    hora: dataHora.toLocaleString(),
    rg, nome, matricula, nasc, pai, mae,
    criminal: criminal.value === 'sim',
    passagem,
    endereco,
    coords,
    obs: ''
  };
  // salvar
  saveRegistro(reg);
  // atualizar UI
  setHoraNow();
  renderLista();
  toast('Abordado adicionado');
  form.reset();
  setHoraNow();
});

// boot
(function boot(){
  setHoraNow();
  // tenta atualizar localização no boot (se permitido)
  updateLocationAndAddress().catch(()=>{});
  renderLista();
  document.getElementById('status').textContent = 'pronto';
})();

</script>
</body>
</html>
